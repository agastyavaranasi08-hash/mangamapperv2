<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manga↔Light Novel↔Anime Linker</title>
  <meta name="description" content="Link chapters across manga, light novels, and anime. Rate arcs, see gaps/inconsistencies, and export/import your data. No backend—fully static.">
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple scrollbar improvement */
    * { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* Tiny utility for truncated cells */
    .truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* Basic modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.6);z-index:50}
    .modal.open{display:flex}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="rounded-xl bg-indigo-600 text-white px-3 py-1 font-semibold">MLA</div>
      <h1 class="text-lg md:text-xl font-bold">Manga ↔ Light Novel ↔ Anime Linker</h1>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnExport" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Export JSON</button>
        <label class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100 cursor-pointer">Import JSON
          <input id="importFile" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnReset" class="px-3 py-1.5 rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50">Reset</button>
        <a href="#/about" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">About</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 md:grid-cols-12 gap-6">
    <!-- Sidebar: Series & Arcs -->
    <aside class="md:col-span-4 lg:col-span-3">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 flex flex-col gap-4">
        <div class="flex items-center gap-2">
          <input id="seriesName" class="flex-1 rounded-xl border border-slate-300 px-3 py-2" placeholder="New series name" />
          <button id="addSeries" class="rounded-xl bg-indigo-600 text-white px-3 py-2 hover:bg-indigo-700">Add</button>
        </div>
        <div id="seriesList" class="flex flex-col gap-2"></div>
      </div>
    </aside>

    <!-- Content Panel -->
    <section id="content" class="md:col-span-8 lg:col-span-9 min-h-[60vh]">
      <!-- Dynamic content renders here -->
    </section>
  </main>

  <!-- Simple Modal for New Arc -->
  <div id="arcModal" class="modal">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6">
      <h3 class="text-lg font-semibold mb-4">Create new arc</h3>
      <div class="space-y-3">
        <input id="arcTitle" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Arc title (e.g., 'Prologue', 'Forest Training')">
        <textarea id="arcSummary" rows="3" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Short summary / notes (optional)"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-5">
        <button id="arcCancel" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Cancel</button>
        <button id="arcCreate" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Create</button>
      </div>
    </div>
  </div>

  <script>
  /*************************
   * Data & Persistence
   *************************/
  const LS_KEY = 'mla-data-v1';
  const uid = () => Math.random().toString(36).slice(2, 9);

  /** @type {import('./').MLAData} */
  let DB = {
    series: [] // {id, name, arcs:[{id,title,summary,rating,mappings:[{id, label, manga, ln, anime, notes}], chat:[{id, parentId|null, text, ts}]}]}
  };

  function save() { localStorage.setItem(LS_KEY, JSON.stringify(DB)); }
  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) { seedExample(); return; }
    try { DB = JSON.parse(raw); } catch { seedExample(); }
  }

  function seedExample(){
    DB = {
      series: [
        { id: uid(), name: 'Example Series', arcs: [
          { id: uid(), title: 'Prologue', summary: 'Hero introduction. LN has extra worldbuilding.', rating: 3,
            mappings: [
              { id: uid(), label: 'Intro segment', manga: 'Ch 1', ln: 'Vol 1 Ch 1–2', anime: 'Ep 1 (0:00–10:30)', notes: 'LN more detail than anime.' },
              { id: uid(), label: 'Town arrival', manga: 'Ch 2', ln: 'Vol 1 Ch 3', anime: '', notes: 'Anime compressed—missing scene.' },
            ],
            chat: [
              { id: uid(), parentId: null, text: 'LN has a short extra scene in the tavern.', ts: Date.now()-86400000 },
              { id: uid(), parentId: null, text: 'Anime moves a reveal earlier.', ts: Date.now()-3600000 }
            ]
          }
        ]}
      ]
    };
    save();
  }

  /*************************
   * Utilities
   *************************/
  function el(html){
    const t = document.createElement('template');
    t.innerHTML = html.trim();
    return t.content.firstElementChild;
  }

  function starRow(val=0){
    return el(`<div class="flex items-center gap-1" data-stars>
      ${[1,2,3,4,5].map(n=>`<button data-star="${n}" class="text-amber-400">${n<=val? '★':'☆'}</button>`).join('')}
    </div>`);
  }

  function badge(text, tone='slate'){ return `<span class="inline-block text-xs px-2 py-0.5 rounded-full bg-${tone}-100 text-${tone}-700 border border-${tone}-200">${text}</span>` }

  function computeArcHealth(arc){
    // Very simple gap/inconsistency heuristics for MVP
    const counts = { m:0, l:0, a:0 };
    arc.mappings.forEach(m => {
      if (m.manga && m.manga.trim()) counts.m++;
      if (m.ln && m.ln.trim()) counts.l++;
      if (m.anime && m.anime.trim()) counts.a++;
    });
    const missing = ['manga','ln','anime'].filter(kind => arc.mappings.some(m => !m[kind] || !m[kind].trim()));
    let status = 'OK';
    if (missing.length) status = 'Gaps';
    if (Math.abs(counts.m - counts.l) + Math.abs(counts.m - counts.a) + Math.abs(counts.l - counts.a) >= 2) status = 'Mismatched';
    return { counts, missing, status };
  }

  function download(filename, text){
    const a = document.createElement('a');
    a.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
    a.setAttribute('download', filename);
    a.click();
  }

  /*************************
   * Sidebar (Series/Arcs)
   *************************/
  function renderSeriesList(){
    const wrap = document.getElementById('seriesList');
    wrap.innerHTML = '';
    if (!DB.series.length) {
      wrap.innerHTML = `<div class="text-sm text-slate-500">No series yet. Add one above.</div>`;
      return;
    }
    DB.series.forEach(series => {
      const node = el(`<div class="border border-slate-200 rounded-xl overflow-hidden">
        <div class="flex items-center gap-2 p-3 bg-slate-50">
          <button class="font-semibold text-left flex-1 hover:underline" data-nav="#/series/${series.id}">${series.name}</button>
          <button title="Delete series" data-del-series class="text-slate-400 hover:text-rose-600">✕</button>
        </div>
        <div class="p-3 space-y-2" data-arc-list></div>
        <div class="p-3 pt-0">
          <button class="text-sm px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100" data-new-arc>Add arc</button>
        </div>
      </div>`);
      // arcs
      const list = node.querySelector('[data-arc-list]');
      series.arcs.forEach(arc => {
        const health = computeArcHealth(arc);
        const arcNode = el(`<div class="flex items-center gap-2">
          <a class="flex-1 truncate hover:underline" href="#/series/${series.id}/arc/${arc.id}">${arc.title}</a>
          ${badge(health.status, health.status==='OK'? 'emerald': (health.status==='Gaps'? 'amber':'rose'))}
          <div class="text-xs text-slate-500">M:${health.counts.m} L:${health.counts.l} A:${health.counts.a}</div>
        </div>`);
        list.appendChild(arcNode);
      });
      // actions
      node.querySelector('[data-new-arc]').addEventListener('click', () => openArcModal(series.id));
      node.querySelector('[data-del-series]').addEventListener('click', () => {
        if (confirm(`Delete series “${series.name}”?`)){
          DB.series = DB.series.filter(s => s.id !== series.id); save(); renderAll();
        }
      });
      node.querySelector('[data-nav]').addEventListener('click', (e)=>{
        location.hash = e.currentTarget.getAttribute('data-nav');
      });
      wrap.appendChild(node);
    });
  }

  function openArcModal(seriesId){
    const modal = document.getElementById('arcModal');
    modal.classList.add('open');
    const title = document.getElementById('arcTitle');
    const summary = document.getElementById('arcSummary');
    title.value=''; summary.value=''; title.focus();
    const cancel = document.getElementById('arcCancel');
    const create = document.getElementById('arcCreate');

    function cleanup(){
      modal.classList.remove('open');
      create.replaceWith(create.cloneNode(true)); // remove listeners
      cancel.replaceWith(cancel.cloneNode(true));
    }

    cancel.addEventListener('click', cleanup, { once:true });
    create.addEventListener('click', () => {
      const s = DB.series.find(s => s.id===seriesId);
      if (!s) return cleanup();
      const arc = { id: uid(), title: title.value.trim()||'Untitled Arc', summary: summary.value.trim(), rating: 0, mappings: [], chat: [] };
      s.arcs.push(arc); save(); cleanup(); renderAll(); location.hash = `#/series/${seriesId}/arc/${arc.id}`;
    }, { once:true });
  }

  /*************************
   * Content Views
   *************************/
  function viewHome(){
    const c = document.getElementById('content');
    c.innerHTML = `
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
        <h2 class="text-xl font-semibold">Welcome</h2>
        <p class="mt-2 text-slate-600">Create a series on the left. Inside a series, add arcs and map corresponding content across <strong>manga chapters</strong>, <strong>light-novel chapters</strong>, and <strong>anime episodes</strong>. The app highlights gaps (missing links) and simple mismatches.</p>
        <ul class="mt-4 list-disc ml-6 text-slate-700 space-y-1">
          <li><strong>No backend</strong>: your data stays in your browser (localStorage).</li>
          <li><strong>Export/Import</strong> JSON to move devices or publish a dataset.</li>
          <li><strong>Ratings</strong>: Star-rate each arc.</li>
          <li><strong>Notes & Chat (local)</strong>: Add notes per mapping and simple per-arc discussion threads.</li>
        </ul>
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-xl text-amber-900">
          Tip: Use ranges like “Vol 2 Ch 3–5”, “Ep 4 (12:00–18:30)”, or “Ch 10–12”.
        </div>
      </div>`;
  }

  function viewAbout(){
    const c = document.getElementById('content');
    c.innerHTML = `
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6 space-y-4">
        <h2 class="text-xl font-semibold">About this app</h2>
        <p class="text-slate-700">Static, single-file web app meant for GitHub Pages or Vercel. No database or server required. You can progressively enhance later (auth, cloud DB, realtime chat) without changing the core UX.</p>
        <ol class="list-decimal ml-6 text-slate-700 space-y-1">
          <li>Click <strong>Export JSON</strong> to save your work. Commit it to your repo to share a dataset.</li>
          <li>Use <strong>Import JSON</strong> to load a data file.</li>
          <li>Host by pushing this <code>index.html</code> to GitHub and turning on Pages (or deploy to Vercel).</li>
        </ol>
      </div>`;
  }

  function viewSeries(seriesId){
    const s = DB.series.find(s => s.id===seriesId);
    const c = document.getElementById('content');
    if (!s){ c.innerHTML = '<div class="text-slate-500">Series not found.</div>'; return; }

    const totalArcs = s.arcs.length;
    const avgRating = (s.arcs.reduce((a,b)=>a+(b.rating||0),0)/(totalArcs||1)).toFixed(1);

    c.innerHTML = `
      <div class="flex flex-col gap-4">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 flex items-center gap-4">
          <div>
            <h2 class="text-xl font-semibold">${s.name}</h2>
            <div class="text-sm text-slate-600">${totalArcs} arcs • Avg rating ${isNaN(avgRating)?'-':avgRating}</div>
          </div>
          <div class="ml-auto flex items-center gap-2">
            <button id="renameSeries" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Rename</button>
            <button id="addArcFromSeries" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Add arc</button>
          </div>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          ${s.arcs.map(arc=>{
            const h = computeArcHealth(arc);
            return `
            <a href="#/series/${s.id}/arc/${arc.id}" class="block bg-white border border-slate-200 rounded-2xl shadow-sm p-4 hover:shadow-md transition">
              <div class="flex items-start gap-2">
                <div class="flex-1">
                  <div class="font-semibold">${arc.title}</div>
                  <div class="text-sm text-slate-600 truncate-2 mt-0.5">${arc.summary||''}</div>
                </div>
                ${badge(h.status, h.status==='OK'? 'emerald': (h.status==='Gaps'? 'amber':'rose'))}
              </div>
              <div class="mt-3 text-xs text-slate-500">M:${h.counts.m} L:${h.counts.l} A:${h.counts.a}</div>
              <div class="mt-2 text-amber-400">${'★'.repeat(arc.rating||0)}${'☆'.repeat(5-(arc.rating||0))}</div>
            </a>`
          }).join('')}
        </div>
      </div>`;

    document.getElementById('renameSeries').addEventListener('click', () => {
      const name = prompt('Rename series', s.name);
      if (name!==null){ s.name = name.trim()||s.name; save(); renderAll(); }
    });
    document.getElementById('addArcFromSeries').addEventListener('click', () => openArcModal(s.id));
  }

  function viewArc(seriesId, arcId){
    const s = DB.series.find(s => s.id===seriesId);
    const c = document.getElementById('content');
    if (!s){ c.innerHTML = 'Series not found.'; return; }
    const arc = s.arcs.find(a => a.id===arcId);
    if (!arc){ c.innerHTML = 'Arc not found.'; return; }

    const h = computeArcHealth(arc);

    c.innerHTML = `
      <div class="flex flex-col gap-4">
        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 flex items-center gap-4">
          <div class="flex-1">
            <h2 class="text-xl font-semibold">${s.name} — <span class="text-slate-700">${arc.title}</span></h2>
            <div class="text-sm text-slate-600">${badge(h.status, h.status==='OK'? 'emerald': (h.status==='Gaps'? 'amber':'rose'))} <span class="ml-2">M:${h.counts.m} L:${h.counts.l} A:${h.counts.a}</span></div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-sm text-slate-600">Rating:</div>
            <div id="starWrap"></div>
            <button id="deleteArc" class="px-3 py-1.5 rounded-lg border border-rose-300 text-rose-700 hover:bg-rose-50">Delete arc</button>
          </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
          <div class="flex items-center gap-2">
            <input id="arcTitleEdit" class="flex-1 rounded-xl border border-slate-300 px-3 py-2" value="${arc.title}" />
            <button id="saveArcTitle" class="px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-100">Save</button>
          </div>
          <textarea id="arcSummaryEdit" rows="2" class="mt-3 w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Arc summary">${arc.summary||''}</textarea>
        </div>

        <div class="grid lg:grid-cols-3 gap-4">
          ${['manga','ln','anime'].map(kind=>`
          <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold capitalize">${kind==='ln'?'Light novel':kind}</h3>
              <button class="text-sm px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100" data-add-mapping="${kind}">Add mapping</button>
            </div>
            <div class="space-y-2" data-map-list="${kind}"></div>
          </div>`).join('')}
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
          <h3 class="font-semibold mb-3">Combined Mapping Table</h3>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-slate-100 text-slate-700">
                  <th class="text-left px-3 py-2">Label</th>
                  <th class="text-left px-3 py-2">Manga</th>
                  <th class="text-left px-3 py-2">Light novel</th>
                  <th class="text-left px-3 py-2">Anime</th>
                  <th class="text-left px-3 py-2">Notes</th>
                  <th class="text-left px-3 py-2">Actions</th>
                </tr>
              </thead>
              <tbody id="mapTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Arc Discussion (local)</h3>
            <button id="newThread" class="text-sm px-2 py-1 rounded-lg border border-slate-300 hover:bg-slate-100">New thread</button>
          </div>
          <div id="chatList" class="space-y-3"></div>
        </div>
      </div>`;

    // Stars
    const stars = starRow(arc.rating||0);
    stars.addEventListener('click', (e)=>{
      const n = e.target.getAttribute('data-star');
      if (!n) return;
      arc.rating = parseInt(n); save(); viewArc(seriesId, arcId);
    });
    document.getElementById('starWrap').appendChild(stars);

    // Title/Summary save
    document.getElementById('saveArcTitle').addEventListener('click', ()=>{
      arc.title = document.getElementById('arcTitleEdit').value.trim()||arc.title;
      arc.summary = document.getElementById('arcSummaryEdit').value.trim();
      save(); renderAll();
    });

    // Delete arc
    document.getElementById('deleteArc').addEventListener('click', ()=>{
      if (confirm(`Delete arc “${arc.title}”?`)){
        s.arcs = s.arcs.filter(a => a.id!==arc.id); save(); location.hash = `#/series/${s.id}`; renderAll();
      }
    });

    // Mapping lists per kind (quick-add inputs)
    ['manga','ln','anime'].forEach(kind => {
      const list = c.querySelector(`[data-map-list="${kind}"]`);
      const row = el(`<div class="flex gap-2">
        <input class="flex-1 rounded-xl border border-slate-300 px-3 py-2" placeholder="e.g., Ch 10–12, Vol 2 Ch 3–5, Ep 4 (12:00–18:30)">
        <button class="px-3 py-2 rounded-xl bg-slate-800 text-white">Add</button>
      </div>`);
      const input = row.querySelector('input');
      row.querySelector('button').addEventListener('click', ()=>{
        // Add a new combined mapping with only this side filled (if no empty slot exists)
        const empty = arc.mappings.find(m => !m.manga && !m.ln && !m.anime);
        const target = empty || { id: uid(), label: '', manga: '', ln: '', anime: '', notes: '' };
        target[kind] = input.value.trim();
        if (!empty) arc.mappings.push(target);
        input.value = '';
        save(); viewArc(seriesId, arcId);
      });
      list.appendChild(row);
    });

    // Combined mapping table
    const tbody = document.getElementById('mapTableBody');
    arc.mappings.forEach(m => {
      const tr = el(`<tr class="border-b border-slate-200">
        <td class="px-3 py-2 w-48"><input value="${m.label||''}" class="w-full rounded-lg border border-slate-300 px-2 py-1" placeholder="Label (optional)"></td>
        <td class="px-3 py-2 w-48"><input value="${m.manga||''}" class="w-full rounded-lg border border-slate-300 px-2 py-1" placeholder="e.g., Ch 10–12"></td>
        <td class="px-3 py-2 w-56"><input value="${m.ln||''}" class="w-full rounded-lg border border-slate-300 px-2 py-1" placeholder="e.g., Vol 2 Ch 3–5"></td>
        <td class="px-3 py-2 w-56"><input value="${m.anime||''}" class="w-full rounded-lg border border-slate-300 px-2 py-1" placeholder="e.g., Ep 4 (12:00–18:30)"></td>
        <td class="px-3 py-2"><input value="${m.notes||''}" class="w-full rounded-lg border border-slate-300 px-2 py-1" placeholder="Notes"></td>
        <td class="px-3 py-2 whitespace-nowrap">
          <button class="px-2 py-1 text-xs rounded-md border border-slate-300 hover:bg-slate-100" data-act="save">Save</button>
          <button class="ml-1 px-2 py-1 text-xs rounded-md border border-rose-300 text-rose-700 hover:bg-rose-50" data-act="del">Delete</button>
        </td>
      </tr>`);
      const inputs = tr.querySelectorAll('input');
      tr.querySelector('[data-act="save"]').addEventListener('click', ()=>{
        [m.label, m.manga, m.ln, m.anime, m.notes] = [...inputs].map(i=>i.value.trim());
        save(); viewArc(seriesId, arcId);
      });
      tr.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        arc.mappings = arc.mappings.filter(x=>x.id!==m.id); save(); viewArc(seriesId, arcId);
      });
      tbody.appendChild(tr);
    });

    // Chat (very simple threads)
    function renderChat(){
      const list = document.getElementById('chatList');
      list.innerHTML = '';
      const threads = arc.chat.filter(p=>!p.parentId).sort((a,b)=>a.ts-b.ts);
      threads.forEach(t => {
        const replies = arc.chat.filter(p=>p.parentId===t.id).sort((a,b)=>a.ts-b.ts);
        const card = el(`<div class="border border-slate-200 rounded-xl p-3">
          <div class="text-sm">${escapeHtml(t.text)}</div>
          <div class="text-xs text-slate-500 mt-1">${new Date(t.ts).toLocaleString()}</div>
          <div class="mt-2 ml-3 space-y-2" data-replies></div>
          <div class="mt-2 flex gap-2">
            <input class="flex-1 rounded-lg border border-slate-300 px-2 py-1" placeholder="Reply…">
            <button class="px-2 py-1 text-xs rounded-md border border-slate-300 hover:bg-slate-100">Send</button>
            <button class="ml-auto px-2 py-1 text-xs rounded-md border border-rose-300 text-rose-700 hover:bg-rose-50" data-del>Delete</button>
          </div>
        </div>`);
        const repliesWrap = card.querySelector('[data-replies]');
        replies.forEach(r => {
          repliesWrap.appendChild(el(`<div class="text-sm"><span class="text-slate-500 mr-2">↳</span>${escapeHtml(r.text)} <span class="text-xs text-slate-400 ml-2">${new Date(r.ts).toLocaleString()}</span></div>`));
        });
        const input = card.querySelector('input');
        const sendBtn = card.querySelector('button');
        sendBtn.addEventListener('click', ()=>{
          const text = input.value.trim(); if(!text) return; input.value='';
          arc.chat.push({ id: uid(), parentId: t.id, text, ts: Date.now() }); save(); renderChat();
        });
        card.querySelector('[data-del]').addEventListener('click', ()=>{
          if (confirm('Delete thread including replies?')){
            arc.chat = arc.chat.filter(p => p.id!==t.id && p.parentId!==t.id); save(); renderChat();
          }
        });
        list.appendChild(card);
      });
    }
    document.getElementById('newThread').addEventListener('click', ()=>{
      const text = prompt('Start a new thread:');
      if (text && text.trim()) { arc.chat.push({ id: uid(), parentId: null, text: text.trim(), ts: Date.now() }); save(); renderChat(); }
    });
    renderChat();
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c]));
  }

  /*************************
   * Router
   *************************/
  function router(){
    const hash = location.hash || '#/';
    const parts = hash.slice(2).split('/');
    if (parts[0]==='about') return viewAbout();
    if (!parts[0]) return viewHome();
    if (parts[0]==='series' && parts[1]){
      const sid = parts[1];
      if (parts[2]==='arc' && parts[3]) return viewArc(sid, parts[3]);
      return viewSeries(sid);
    }
    viewHome();
  }

  /*************************
   * Init & Global Events
   *************************/
  function renderAll(){ renderSeriesList(); router(); }

  load();
  renderAll();

  window.addEventListener('hashchange', router);

  document.getElementById('addSeries').addEventListener('click', ()=>{
    const name = document.getElementById('seriesName').value.trim();
    if (!name) return;
    DB.series.push({ id: uid(), name, arcs: [] });
    document.getElementById('seriesName').value='';
    save(); renderAll();
  });

  document.getElementById('btnExport').addEventListener('click', ()=>{
    download('mla-data.json', JSON.stringify(DB, null, 2));
  });

  document.getElementById('importFile').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try { const data = JSON.parse(reader.result); if(!data.series) throw new Error('Invalid file'); DB = data; save(); renderAll(); alert('Imported!'); }
      catch(err){ alert('Import failed: '+ err.message); }
      finally { e.target.value = ''; }
    };
    reader.readAsText(file);
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    if (confirm('Reset all data?')){ localStorage.removeItem(LS_KEY); load(); renderAll(); }
  });

  </script>
</body>
</html>
